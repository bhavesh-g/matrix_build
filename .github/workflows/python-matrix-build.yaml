# .github/workflows/python-matrix-build.yml
name: Multi-Python Build Matrix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  FORCE_COLOR: 1

jobs:
  setup:
    name: Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      python-versions: ${{ steps.set-versions.outputs.matrix }}
      build-name: ${{ steps.set-info.outputs.name }}
    steps:
      - name: Determine Python Versions
        id: set-versions
        run: |
          echo 'matrix=["3.7","3.8","3.9","3.10","3.11","3.12","3.13"]' >> "$GITHUB_OUTPUT"

      - name: Set Build Information
        id: set-info
        run: |
          echo "name=build-$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

  build:
    name: Python ${{ matrix.python-version }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        python-version: ${{ fromJson(needs.setup.outputs.python-versions) }}
    continue-on-error: ${{ matrix.python-version != '3.13' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Application (import test)
        id: build-app
        run: |
          python - << 'EOF'
          from app.main import app
          print("Imported app:", bool(app))
          print("Routes:", len(app.routes))
          EOF

      - name: Version Compatibility Check (3.10+ required)
        id: compat
        run: |
          python - << 'EOF'
          import sys
          if sys.version_info < (3, 10):
              raise SystemExit("Intentional incompatibility: requires Python >= 3.10")
          print("Base features OK:", sys.version)
          EOF

      - name: Runtime Smoke Test (enforce 3.13-only /as13 behavior)
        id: runtime
        run: |
          timeout 10s python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 3
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/pattern-match || exit 1
          py_ver=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          if [ "$py_ver" = "3.13" ]; then
            echo "Expecting /as13 to succeed on Python 3.13"
            curl -f http://localhost:8000/as13 || exit 1
          else
            echo "Expecting /as13 to fail on Python < 3.13"
            if curl -fsS http://localhost:8000/as13 >/dev/null; then
              echo "Unexpected success for /as13 on Python $py_ver"
              exit 1
            fi
          fi
          pkill -f uvicorn || true

      - name: Write Compatibility Status
        if: always()
        run: |
          status="incompatible"
          if [ "${{ steps.build-app.outcome }}" = "success" ] && \
             [ "${{ steps.compat.outcome }}" = "success" ] && \
             [ "${{ steps.runtime.outcome }}" = "success" ]; then
            status="compatible"
          fi
          echo "$status" > "status_${{ matrix.python-version }}.txt"

      - name: Upload Status Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ matrix.python-version }}
          path: status_${{ matrix.python-version }}.txt
          if-no-files-found: warn

  summary:
    name: Compatibility Summary
    needs: [setup, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download All Status Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: status-*
          merge-multiple: true

      - name: Compute Compatibility Lists
        id: compute
        env:
          VERSIONS_JSON: ${{ needs.setup.outputs.python-versions }}
        run: |
          python - << 'PY'
          import json, os
          versions = json.loads(os.environ["VERSIONS_JSON"])
          compatible, incompatible = [], []
          for v in versions:
            fn = f"status_{v}.txt"
            if os.path.exists(fn):
              try:
                with open(fn, "r", encoding="utf-8") as f:
                  (compatible if f.read().strip() == "compatible" else incompatible).append(v)
              except Exception:
                incompatible.append(v)
            else:
              incompatible.append(v)
          # Emit compact lines to logs for quick copy/paste
          print("Compatible:", " ".join(compatible))
          print("Incompatible:", " ".join(incompatible))
          # Also write the two-line summary to the run's Summary
          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as s:
            s.write(f"Compatible: {' '.join(compatible)}\n")
            s.write(f"Incompatible: {' '.join(incompatible)}\n")
          PY

      - name: Annotate Summary Lines In Logs
        run: |
          # Optional: visible annotations in the log
          echo "::notice title=Compatibility::$(sed -n '1p' $GITHUB_STEP_SUMMARY)"
          echo "::notice title=Compatibility::$(sed -n '2p' $GITHUB_STEP_SUMMARY)"
