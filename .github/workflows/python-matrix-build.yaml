# .github/workflows/python-matrix-build.yml
name: ğŸš€ Multi-Python Build Matrix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  FORCE_COLOR: 1

jobs:
  # Dynamic Matrix Setup
  setup:
    name: ğŸ”§ Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      python-versions: ${{ steps.versions.outputs.matrix }}
      build-name: ${{ steps.info.outputs.name }}
    
    steps:
      - name: ğŸ“‹ Determine Python Versions
        id: versions
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo 'matrix=["3.10", "3.11", "3.12"]' >> $GITHUB_OUTPUT
          else
            echo 'matrix=["3.9", "3.10", "3.11", "3.12", "3.13-dev"]' >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“ Build Information
        id: info
        run: |
          echo "name=build-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Target: ${{ github.ref_name }}"
          echo "ğŸ”€ Event: ${{ github.event_name }}"

  # Main Build Matrix - Maximum Parallelism
  build:
    name: ğŸ Python ${{ matrix.python-version }}
    needs: setup
    runs-on: ubuntu-latest
    
    strategy:
      # Strategic fail-fast: disabled for comprehensive feedback
      fail-fast: false
      # Max parallel jobs for speed
      max-parallel: 6
      matrix:
        python-version: ${{ fromJson(needs.setup.outputs.python-versions) }}
    
    # Continue experimental versions even if they fail  
    continue-on-error: ${{ matrix.python-version == '3.13-dev' }}
    
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements*.txt'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”§ Installing for Python ${{ matrix.python-version }}"
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Dependencies installed successfully"
      
      - name: ğŸ—ï¸ Build Application
        run: |
          echo "ğŸš€ Building FastAPI app with Python ${{ matrix.python-version }}"
          python -c "
          import sys
          from app.main import app
          print(f'âœ… Build successful on Python {sys.version}')
          print(f'ğŸ¯ App title: {app.title}')
          print(f'ğŸ”§ Available features: {len(app.routes)} routes')
          "
      
      - name: ğŸ” Version Compatibility Check
        run: |
          echo "ğŸ§ª Testing Python ${{ matrix.python-version }} compatibility"
          python -c "
          import sys
          from app.main import get_version_features
          
          print(f'Python {sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}')
          features = get_version_features()
          print(f'Available features: {features}')
          
          # Version-specific validation
          if sys.version_info >= (3, 10):
              print('âœ… Pattern matching supported')
          if sys.version_info >= (3, 11):
              print('âœ… Performance optimizations active')
          if sys.version_info >= (3, 12):
              print('âœ… Latest syntax features available')
              
          print('ğŸ‰ Compatibility check passed!')
          "
      
      - name: ğŸš€ Test Application Start
        run: |
          echo "ğŸŒ Testing app startup with Python ${{ matrix.python-version }}"
          timeout 10s python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 3
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/build-info || exit 1
          echo "âœ… Application starts and responds successfully"
          pkill -f uvicorn
      
      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ¯ Build Summary for Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Application built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Compatibility validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Runtime test passed" >> $GITHUB_STEP_SUMMARY

  # Build Status Summary  
  build-status:
    name: ğŸ“ˆ Build Status Summary
    needs: [setup, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Build Report
        run: |
          echo "# ğŸš€ Multi-Python Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Python Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          
          # This would be populated by the actual build results
          echo "Build completed for all Python versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID:** ${{ needs.setup.outputs.build-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
      
      - name: âœ… Success Notification  
        if: needs.build.result == 'success'
        run: |
          echo "ğŸ‰ All Python versions built successfully!"
          echo "âœ… Ready for deployment across environments"
      
      - name: âŒ Failure Analysis
        if: needs.build.result == 'failure'  
        run: |
          echo "âŒ Some builds failed - check individual job logs"
          echo "ğŸ” Review compatibility issues in failed versions"
          exit 1

  # Optional: Fast Deploy Check (only on main)
  deploy-check:
    name: ğŸš€ Deploy Readiness
    needs: [build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.build.result == 'success'
    
    steps:
      - name: âœ… Deployment Ready
        run: |
          echo "ğŸ¯ All Python versions validated"
          echo "ğŸš€ Application ready for multi-environment deployment"
          echo "ğŸ“¦ Builds completed successfully across:"
          echo "   - Development environments (Python 3.10+)"
          echo "   - Production environments (Python 3.11+)"  
          echo "   - Legacy support (Python 3.9+)"
